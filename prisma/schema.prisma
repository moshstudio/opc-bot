// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  companies Company[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Company {
  id            String          @id @default(uuid())
  name          String
  type          String          @default("custom") // custom, developer, media, education
  ownerId       String
  owner         User            @relation(fields: [ownerId], references: [id])
  employees      Employee[]
  tasks          Task[]
  knowledgeBases KnowledgeBase[]
  notifications  Notification[]
  systemConfigs  SystemConfig[]
  aiModels       AiModel[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model AiModel {
  id             String   @id @default(uuid())
  name           String
  provider       String   // "openai", "azure", "anthropic", "google", "transformers", "custom"
  category       String   // "chat", "embedding"
  baseUrl        String?
  apiKey         String?
  supportsImages Boolean  @default(false)
  isActive       Boolean  @default(true) // visible or usable
  
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Employee {
  id          String     @id @default(uuid())
  name        String
  role        String     // e.g., "Assistant", "DevOps", "ProductManager"
  config      String?    // JSON string for specific configuration (prompts, tools)
  workflow    String?    // JSON string for the employee's internal workflow definition
  permissions String?    // JSON string for permissions: { canRead: bool, canWrite: bool, canExecute: bool, ... }
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id])
  parentId    String?
  manager     Employee?  @relation("Management", fields: [parentId], references: [id])
  subordinates Employee[] @relation("Management")
  // Sub-employee links
  linkedFrom  EmployeeLink[] @relation("LinkSource")
  linkedTo    EmployeeLink[] @relation("LinkTarget")
  tasks        Task[]
  messages     Message[]
  employeeLogs EmployeeLog[]
  status      String     @default("idle") // idle, working, etc.
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Represents a link from one employee to a sub-employee
model EmployeeLink {
  id            String   @id @default(uuid())
  sourceId      String
  source        Employee @relation("LinkSource", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId      String
  target        Employee @relation("LinkTarget", fields: [targetId], references: [id], onDelete: Cascade)
  permissions   String?  // JSON: inherited or custom permissions for this link
  description   String?  // Optional description of the link
  createdAt     DateTime @default(now())
}

model Message {
  id         String   @id @default(uuid())
  content    String
  role       String   // "user" or "assistant"
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  createdAt  DateTime @default(now())
}

model Task {
  id           String    @id @default(uuid())
  title        String
  description  String?
  status       String    @default("PENDING") // PENDING, IN_PROGRESS, REVIEWING, COMPLETED, FAILED, PAUSED
  assignedToId String?
  assignedTo   Employee? @relation(fields: [assignedToId], references: [id])
  companyId    String
  company      Company   @relation(fields: [companyId], references: [id])
  logs         String?   // JSON string for execution logs (optional for now)
  
  // æ–°å¢ï¼šä»»åŠ¡ä¸Šä¸‹æ–‡å’Œç»“æœ
  context      String?   // JSON æ ¼å¼ï¼Œå­˜å‚¨ä¸­æ¢æ‹†è§£æ—¶çš„å‰ç½®ä¾èµ–ã€è¦æ±‚ç­‰
  result       String?   // å­˜å‚¨è¯¥ä»»åŠ¡çš„æœ€ç»ˆæ‰§è¡ŒæŠ¥å‘Šæˆ–ä»£ç 

  // æ–°å¢ï¼šçˆ¶å­ä»»åŠ¡æ”¯æŒ
  parentTaskId String?
  parentTask   Task?     @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks     Task[]    @relation("SubTasks")

  // æ–°å¢ï¼šä»»åŠ¡å¯¹è¯æ¶ˆæ¯
  messages     TaskMessage[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// ä»»åŠ¡æ²Ÿé€šæˆ–è¿­ä»£æ‰“å›è¿‡ç¨‹è®°å½•
model TaskMessage {
  id         String   @id @default(uuid())
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  role       String   // "system" (ä¸­æ¢) | "assistant" (å‘˜å·¥)
  content    String   // æ²Ÿé€šå†…å®¹ã€è¯„å®¡æ„è§ã€æ‰“å›åŸå› ç­‰
  createdAt  DateTime @default(now())
}

model KnowledgeBase {
  id          String     @id @default(uuid())
  name        String
  description String?
  icon        String     @default("ğŸ“š")
  content     String     @default("") // Legacy field, kept for backward compatibility
  isShared    Boolean    @default(true)
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id])
  documents   Document[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Document {
  id              String        @id @default(uuid())
  name            String
  content         String
  type            String        @default("text") // text, url
  status          String        @default("ready") // ready, processing, error
  errorMessage    String?       // è®°å½•å¤„ç†é”™è¯¯ä¿¡æ¯
  wordCount       Int           @default(0)
  characterCount  Int           @default(0)
  metadata        String?       // JSON string for extra data
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// å‘˜å·¥è¾“å‡ºæ—¥å¿— - è®°å½•æ‰€æœ‰å‘˜å·¥çš„æ“ä½œå’Œè¾“å‡º
model EmployeeLog {
  id          String   @id @default(uuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type        String   // "workflow_execution" | "chat_response" | "task_completion" | "error" | "status_change"
  title       String   // ç®€çŸ­æ ‡é¢˜
  content     String   // è¯¦ç»†å†…å®¹
  metadata    String?  // JSON string for extra data (e.g., workflow results, node details)
  level       String   @default("info") // "info" | "warning" | "error" | "success"
  isProcessed Boolean  @default(false)  // æ˜¯å¦å·²è¢«åŠ©ç†å¤„ç†è¿‡
  createdAt   DateTime @default(now())
}

// é€šçŸ¥ - ç«™å†…é€šçŸ¥ç³»ç»Ÿ
model Notification {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  title       String
  content     String
  type        String   @default("info") // "info" | "warning" | "error" | "success" | "summary"
  source      String   @default("system") // "ivy" | "system" | "employee"
  sourceId    String?  // å…³è”çš„å‘˜å·¥ ID
  isRead      Boolean  @default(false)
  emailSent   Boolean  @default(false) // æ˜¯å¦å·²å‘é€é‚®ä»¶
  createdAt   DateTime @default(now())
}

// ç³»ç»Ÿé…ç½® - å­˜å‚¨å…¨å±€é…ç½®ï¼ˆå¦‚é‚®ç®±æœåŠ¡ï¼‰
model SystemConfig {
  id        String   @id @default(uuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  key       String   // é…ç½®é”®ï¼še.g., "email_smtp", "ivy_schedule", etc.
  value     String   // JSON string of configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, key])
}
